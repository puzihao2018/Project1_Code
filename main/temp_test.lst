0000              1   ; This example uses a technique called "decimation" with the 8-bit ADC
0000              2   ; to increase its efective resolution to 12-bits.  The output of a LM335
0000              3   ; tempererature sensor is read and then diplayed using PUTTy in degrees Celcius.
0000              4   ;
0000              5   ; Some good information about decimation found here:
0000              6   ;
0000              7   ; https://www.cypress.com/file/236481/download
0000              8   
                 10   $LIST
0000             12   ;-------------------;
0000             13   ;    Const Define   ;
0000             14   ;-------------------; 
0000             15   XTAL EQU 7373000
0000             16   BAUD EQU 115200
0000             17   BRVAL EQU ((XTAL/BAUD)-16)
0000             18   
0000             19   CCU_RATE      EQU 100      ; 100Hz, for an overflow rate of 10ms
0000             20   CCU_RELOAD    EQU ((65536-(XTAL/(2*CCU_RATE))))
0000             21   
0000             22   TIMER0_RATE   EQU 4096
0000             23   TIMER0_RELOAD EQU ((65536-(XTAL/(2*TIMER0_RATE))))
0000             24   
0000             25   
0000             26            CSEG at 0x0000
0000 020499      27            ljmp    MainProgram
0003             28   
0003             29   ;-----------------------;
0003             30   ;    Variables Define   ;
0003             31   ;-----------------------; 
0003             32   ;Variable_name: ds n
0030             33   dseg at 0x30
0030             34            Current_Room_Temp: ds 4
0034             35            Current_Oven_Temp: ds 4
0038             36            Current_Room_Volt: ds 4
003C             37            Current_Oven_Volt: ds 4
0040             38            x: ds 4
0044             39            y: ds 4
0048             40            bcd: ds 5
004D             41            
0000             42   bseg
0000             43            mf: dbit 1
0001             44            equal_flag: dbit 1
0002             45            greater_flag: dbit 1
0003             46            lessthan_flag: dbit 1
0004             47   
0004             48   
0004             49   
                559   $LIST
                 51   $LIST
0273             53   
0273             54   putchar:
0273 109902      55            jbc     TI,putchar_L1
0276 80FB        56            sjmp putchar
0278             57   putchar_L1:
0278 F599        58            mov     SBUF,a
027A 22          59            ret
027B             60            
027B             61   getchar:
027B 109802      62            jbc     RI,getchar_L1
027E 80FB        63            sjmp getchar
0280             64   getchar_L1:
0280 E599        65            mov     a,SBUF
0282 22          66            ret
0283             67   
0283             68   Wait1S:
0283 7A28        69            mov R2, #40
0285 79FA        70   L3:      mov R1, #250
0287 78B8        71   L2:      mov R0, #184
0289 D8FE        72   L1:      djnz R0, L1 ; 2 machine cycles-> 2*0.27126us*184=100us
028B D9FA        73            djnz R1, L2 ; 100us*250=0.025s
028D DAF6        74            djnz R2, L3 ; 0.025s*40=1s
028F 22          75            ret
0290             76   
0290             77   InitSerialPort:
0290 75BD00      78            mov     BRGCON,#0x00
0293 75BF00      79            mov     BRGR1,#high(BRVAL)
0296 75BE30      80            mov     BRGR0,#low(BRVAL)
0299 75BD03      81            mov     BRGCON,#0x03 ; Turn-on the baud rate generator
029C 759852      82            mov     SCON,#0x52 ; Serial port in mode 1, ren, txrdy, rxempty
029F 759100      83            mov     P1M1,#0x00 ; Enable pins RxD and TXD
02A2 759200      84            mov     P1M2,#0x00 ; Enable pins RxD and TXD
02A5 22          85            ret
02A6             86   
02A6             87   InitADC:
02A6             88            ; ADC0_0 is connected to P1.7
02A6             89            ; ADC0_1 is connected to P0.0
02A6             90            ; ADC0_2 is connected to P2.1
02A6             91            ; ADC0_3 is connected to P2.0
02A6             92       ; Configure pins P1.7, P0.0, P2.1, and P2.0 as inputs
02A6 438401      93       orl P0M1, #00000001b
02A9 5385FE      94       anl P0M2, #11111110b
02AC 439180      95       orl P1M1, #10000000b
02AF 53927F      96       anl P1M2, #01111111b
02B2 43A403      97       orl P2M1, #00000011b
02B5 53A5FC      98       anl P2M2, #11111100b
02B8             99            ; Setup ADC0
02B8 D2C2       100            setb BURST0 ; Autoscan continuos conversion mode
02BA 75A120     101            mov     ADMODB,#0x20 ;ADC0 clock is 7.3728MHz/2
02BD 75A30F     102            mov     ADINS,#0x0f ; Select the four channels of ADC0 for conversion
02C0 758E05     103            mov     ADCON0,#0x05 ; Enable the converter and start immediately
02C3            104            ; Wait for first conversion to complete
02C3            105   InitADC_L1:
02C3 E58E       106            mov     a,ADCON0
02C5 30E3FB     107            jnb     acc.3,InitADC_L1
02C8 22         108            ret
02C9            109   
02C9 30313233   110   HexAscii: db '0123456789ABCDEF'
     34353637
     38394142
     43444546
02D9            111   
02D9            112   SendTemp0:
02D9 9002C9     113            mov dptr, #HexAscii 
02DC            114            
02DC            115            
02DC            116            
02DC E54B       117            mov a, bcd+3
02DE C4         118            swap a
02DF 540F       119            anl a, #0xf
02E1 93         120            movc a, @a+dptr
02E2 120273     121            lcall putchar
02E5 E54B       122            mov a, bcd+3
02E7 540F       123            anl a, #0xf
02E9 93         124            movc a, @a+dptr
02EA 120273     125            lcall putchar
02ED            126            
02ED E54A       127            mov a, bcd+2
02EF C4         128            swap a
02F0 540F       129            anl a, #0xf
02F2 93         130            movc a, @a+dptr
02F3 120273     131            lcall putchar
02F6 E54A       132            mov a, bcd+2
02F8 540F       133            anl a, #0xf
02FA 93         134            movc a, @a+dptr
02FB 120273     135            lcall putchar
02FE            136            
02FE E549       137            mov a, bcd+1
0300 C4         138            swap a
0301 540F       139            anl a, #0xf
0303 93         140            movc a, @a+dptr
0304 120273     141            lcall putchar
0307 E549       142            mov a, bcd+1
0309 540F       143            anl a, #0xf
030B 93         144            movc a, @a+dptr
030C 120273     145            lcall putchar
030F            146   
030F            147   
030F E548       148            mov a, bcd+0
0311 C4         149            swap a
0312 540F       150            anl a, #0xf
0314 93         151            movc a, @a+dptr
0315 120273     152            lcall putchar
0318 E548       153            mov a, bcd+0
031A 540F       154            anl a, #0xf
031C 93         155            movc a, @a+dptr
031D 120273     156            lcall putchar
0320 22         157            ret
0321            158   
0321            159   Send_NewLine:
0321 740D       160            mov a, #'\r'
0323 120273     161            lcall putchar
0326 740A       162            mov a, #'\n'
0328 120273     163            lcall putchar   
032B 22         164            ret
032C            165            
032C            166   SendString:
032C E4         167       clr a
032D 93         168       movc a, @a+dptr
032E 6006       169       jz SendString_L1
0330 120273     170       lcall putchar
0333 A3         171       inc dptr
0334 80F6       172       sjmp SendString  
0336            173   SendString_L1:
0336 22         174            ret
0337            175   
0337            176   Wait10us:
0337 7812       177       mov R0, #18
0339 D8FE       178       djnz R0, $ ; 2 machine cycles-> 2*0.27126us*18=10us
033B 22         179            ret
033C            180   
033C 0D0A5038   181   InitialMessage: db '\r\nP89LPC9351 ADC decimation example.\r\n', 0
     394C5043
     39333531
     20414443
     20646563
     696D6174
     696F6E20
     6578616D
     706C652E
     0D0A00
0363            182   
0363            183   Read_Oven_Temp:
0363            184            ; Take 256 (4^4) consecutive measurements of ADC0 channel 0 at about 10 us intervals and accumulate in x
0363 754000     185            mov x+0, #low (0 % 0x10000) 
0366 754100     185            mov x+1, #high(0 % 0x10000) 
0369 754200     185            mov x+2, #low (0 / 0x10000) 
036C 754300     185            mov x+3, #high(0 / 0x10000) 
036F 85C740     186       mov x+0, ad0dat2
0372 7FFF       187            mov R7, #255
0374 120337     188       lcall Wait10us
0377            189   accumulate_loop0:
0377 85C744     190       mov y+0, ad0dat2
037A 754500     191       mov y+1, #0
037D 754600     192       mov y+2, #0
0380 754700     193       mov y+3, #0
0383 1200C8     194       lcall add32
0386 120337     195       lcall Wait10us
0389 DFEC       196            djnz R7, accumulate_loop0
038B            197            
038B            198            ; Now divide by 16 (2^4)
038B 754410     199            mov y+0, #low (16 % 0x10000) 
038E 754500     199            mov y+1, #high(16 % 0x10000) 
0391 754600     199            mov y+2, #low (16 / 0x10000) 
0394 754700     199            mov y+3, #high(16 / 0x10000) 
0397 12020A     200            lcall div32
039A            201            ; x has now the 12-bit representation of the temperature
039A            202            
039A            203            ; Convert to temperature (C)
039A 7544E8     204            mov y+0, #low (33000 % 0x10000) 
039D 754580     204            mov y+1, #high(33000 % 0x10000) 
03A0 754600     204            mov y+2, #low (33000 / 0x10000) 
03A3 754700     204            mov y+3, #high(33000 / 0x10000)  ; Vref is 3.3V
03A6 12017D     205            lcall mul32
03A9 754400     206            mov y+0, #low (((1<<12)) % 0x10000) 
03AC 754510     206            mov y+1, #high(((1<<12)) % 0x10000) 
03AF 754600     206            mov y+2, #low (((1<<12)) / 0x10000) 
03B2 754700     206            mov y+3, #high(((1<<12)) / 0x10000)  ; 2^12-1
03B5 12020A     207            lcall div32
03B8 75443C     208            mov y+0, #low (60 % 0x10000) 
03BB 754500     208            mov y+1, #high(60 % 0x10000) 
03BE 754600     208            mov y+2, #low (60 / 0x10000) 
03C1 754700     208            mov y+3, #high(60 / 0x10000) 
03C4 1200E9     209            lcall sub32
03C7            210   
03C7            211       ;mov(dst, src)
03C7 85433F     211            mov Current_Oven_Volt+3, x+3
03CA 85423E     211       mov Current_Oven_Volt+2, x+2
03CD 85413D     211       mov Current_Oven_Volt+1, x+1
03D0 85403C     211       mov Current_Oven_Volt,   x; store the hex value of voltage
03D3            212            
03D3 75440E     213            mov y+0, #low (7438 % 0x10000) 
03D6 75451D     213            mov y+1, #high(7438 % 0x10000) 
03D9 754600     213            mov y+2, #low (7438 / 0x10000) 
03DC 754700     213            mov y+3, #high(7438 / 0x10000) 
03DF 12017D     214            lcall mul32
03E2 754410     215            mov y+0, #low (10000 % 0x10000) 
03E5 754527     215            mov y+1, #high(10000 % 0x10000) 
03E8 754600     215            mov y+2, #low (10000 / 0x10000) 
03EB 754700     215            mov y+3, #high(10000 / 0x10000) 
03EE 12020A     216            lcall div32
03F1            217            ;now we got the relateive temp number in hex
03F1            218   
03F1            219       ;mov(dst, src)
03F1 853347     219            mov y+3, Current_Room_Temp+3
03F4 853246     219       mov y+2, Current_Room_Temp+2
03F7 853145     219       mov y+1, Current_Room_Temp+1
03FA 853044     219       mov y,   Current_Room_Temp
03FD 1200C8     220            lcall add32
0400            221   
0400            222       ;mov(dst, src)
0400 854337     222            mov Current_Oven_Temp+3, x+3
0403 854236     222       mov Current_Oven_Temp+2, x+2
0406 854135     222       mov Current_Oven_Temp+1, x+1
0409 854034     222       mov Current_Oven_Temp,   x
040C 22         223            ret
040D            224   
040D            225   Read_Room_Temp:
040D            226            
040D 754000     227            mov x+0, #low (0 % 0x10000) 
0410 754100     227            mov x+1, #high(0 % 0x10000) 
0413 754200     227            mov x+2, #low (0 / 0x10000) 
0416 754300     227            mov x+3, #high(0 / 0x10000) 
0419 85C740     228       mov x+0, ad0dat2
041C 7FFF       229            mov R7, #255
041E 120337     230       lcall Wait10us
0421            231       
0421            232   accumulate_loop1:
0421 85F444     233       mov y+0, ad0dat3
0424 754500     234       mov y+1, #0
0427 754600     235       mov y+2, #0
042A 754700     236       mov y+3, #0
042D 1200C8     237       lcall add32
0430 120337     238       lcall Wait10us
0433 DFEC       239            djnz R7, accumulate_loop1
0435            240            
0435            241            ; Now divide by 16 (2^4)
0435 754410     242            mov y+0, #low (16 % 0x10000) 
0438 754500     242            mov y+1, #high(16 % 0x10000) 
043B 754600     242            mov y+2, #low (16 / 0x10000) 
043E 754700     242            mov y+3, #high(16 / 0x10000) 
0441 12020A     243            lcall div32
0444            244            ; x has now the 12-bit representation of the temperature
0444            245            
0444            246            ; Convert to temperature (C)
0444 7544E8     247            mov y+0, #low (33000 % 0x10000) 
0447 754580     247            mov y+1, #high(33000 % 0x10000) 
044A 754600     247            mov y+2, #low (33000 / 0x10000) 
044D 754700     247            mov y+3, #high(33000 / 0x10000)  ; Vref is 3.3V
0450 12017D     248            lcall mul32
0453 754400     249            mov y+0, #low (((1<<12)) % 0x10000) 
0456 754510     249            mov y+1, #high(((1<<12)) % 0x10000) 
0459 754600     249            mov y+2, #low (((1<<12)) / 0x10000) 
045C 754700     249            mov y+3, #high(((1<<12)) / 0x10000)  ; 2^12-1
045F 12020A     250            lcall div32
0462 75443C     251            mov y+0, #low (60 % 0x10000) 
0465 754500     251            mov y+1, #high(60 % 0x10000) 
0468 754600     251            mov y+2, #low (60 / 0x10000) 
046B 754700     251            mov y+3, #high(60 / 0x10000) 
046E 1200E9     252            lcall sub32
0471            253            
0471            254            ;now we got the voltage value
0471            255       ;mov(dst, src)
0471 85433B     255            mov Current_Room_Volt+3, x+3
0474 85423A     255       mov Current_Room_Volt+2, x+2
0477 854139     255       mov Current_Room_Volt+1, x+1
047A 854038     255       mov Current_Room_Volt,   x
047D            256            
047D 7544A4     257            mov y+0, #low (27300 % 0x10000) 
0480 75456A     257            mov y+1, #high(27300 % 0x10000) 
0483 754600     257            mov y+2, #low (27300 / 0x10000) 
0486 754700     257            mov y+3, #high(27300 / 0x10000) 
0489 1200E9     258            lcall sub32
048C            259            ;now we got the temperature
048C            260       ;mov(dst, src)
048C 854333     260            mov Current_Room_Temp+3, x+3
048F 854232     260       mov Current_Room_Temp+2, x+2
0492 854131     260       mov Current_Room_Temp+1, x+1
0495 854030     260       mov Current_Room_Temp,   x
0498            261            
0498 22         262            ret
0499            263   
0499            264   
0499            265   MainProgram:
0499 75817F     266       mov SP, #0x7F
049C 120290     267            lcall InitSerialPort
049F 1202A6     268            lcall InitADC
04A2            269   
04A2 120283     270            lcall Wait1S ; Wait a bit so PUTTy has a chance to start
04A5 90033C     271            mov dptr, #InitialMessage
04A8 12032C     272            lcall SendString
04AB            273   
04AB            274   forever_loop:
04AB            275            
04AB 12040D     276            lcall Read_Room_Temp
04AE 120363     277            lcall Read_Oven_Temp
04B1            278   
04B1            279            ;display room voltage and temp
04B1            280       ;mov(dst, src)
04B1 853B43     280            mov x+3, Current_Room_Volt+3
04B4 853A42     280       mov x+2, Current_Room_Volt+2
04B7 853941     280       mov x+1, Current_Room_Volt+1
04BA 853840     280       mov x,   Current_Room_Volt
04BD 120003     281            lcall hex2bcd
04C0 1202D9     282            lcall SendTemp0; send 6 digits value
04C3 7420       283            mov a, #' '
04C5 120273     284            lcall putchar
04C8            285       ;mov(dst, src)
04C8 853343     285            mov x+3, Current_Room_Temp+3
04CB 853242     285       mov x+2, Current_Room_Temp+2
04CE 853141     285       mov x+1, Current_Room_Temp+1
04D1 853040     285       mov x,   Current_Room_Temp
04D4 120003     286            lcall hex2bcd
04D7 1202D9     287            lcall SendTemp0; send 6 digits value
04DA 7420       288            mov a, #' '
04DC 120273     289            lcall putchar
04DF            290   
04DF            291            ;display oven voltage and temp
04DF            292       ;mov(dst, src)
04DF 853F43     292            mov x+3, Current_Oven_Volt+3
04E2 853E42     292       mov x+2, Current_Oven_Volt+2
04E5 853D41     292       mov x+1, Current_Oven_Volt+1
04E8 853C40     292       mov x,   Current_Oven_Volt
04EB 120003     293            lcall hex2bcd
04EE 1202D9     294            lcall SendTemp0
04F1 7420       295            mov a, #' '
04F3 120273     296            lcall putchar
04F6            297       ;mov(dst, src)
04F6 853743     297            mov x+3, Current_Oven_Temp+3
04F9 853642     297       mov x+2, Current_Oven_Temp+2
04FC 853541     297       mov x+1, Current_Oven_Temp+1
04FF 853440     297       mov x,   Current_Oven_Temp
0502 120003     298            lcall hex2bcd
0505 1202D9     299            lcall SendTemp0
0508 7420       300            mov a, #' '
050A 120273     301            lcall putchar
050D            302   
050D 120321     303            lcall Send_NewLine
0510 120283     304            lcall Wait1S
0513 0204AB     305            ljmp forever_loop
0516            306   end
